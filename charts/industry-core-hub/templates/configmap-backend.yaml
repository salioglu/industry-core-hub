{{- /*
* Eclipse Tractus-X - Industry Core Hub
*
* Copyright (c) 2025 LKS NEXT
* Copyright (c) 2025 Contributors to the Eclipse Foundation
*
* See the NOTICE file(s) distributed with this work for additional
* information regarding copyright ownership.
*
* This program and the accompanying materials are made available under the
* terms of the Apache License, Version 2.0 which is available at
* https://www.apache.org/licenses/LICENSE-2.0.
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
* WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
* License for the specific language governing permissions and limitations
* under the License.
*
* SPDX-License-Identifier: Apache-2.0
*/}}

{{- if .Values.backend.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
  labels:
    {{- include "industry-core-hub.backend.labels" . | nindent 4 }}
data:
  configuration.yml: |-
    hostname: {{ include "industry-core-hub.ingressUrl" . | quote }}
    authorization:
      enabled: {{ .Values.backend.configuration.authorization.enabled }}
      api_key:
        key: {{ .Values.backend.configuration.authorization.apiKey.key | quote }}
        value: {{ .Values.backend.configuration.authorization.apiKey.value | toJson }}
      keycloak:
        enabled: {{ .Values.backend.configuration.authorization.keycloak.enabled }}
        auth_url: {{ .Values.backend.configuration.authorization.keycloak.authUrl | quote }}
        realm: {{ .Values.backend.configuration.authorization.keycloak.realm | quote }}
        client_id: {{ .Values.backend.configuration.authorization.keycloak.clientId | quote }}
        client_secret: {{ .Values.backend.configuration.authorization.keycloak.clientSecret | quote }}
        retry:
          max_retries: {{ .Values.backend.configuration.authorization.keycloak.retry.maxRetries }}
          retry_delay: {{ .Values.backend.configuration.authorization.keycloak.retry.retryDelay }}
          background_retry_interval: {{ .Values.backend.configuration.authorization.keycloak.retry.backgroundRetryInterval }}
    agreements: {{ .Values.backend.configuration.agreements | toYaml | nindent 6 }}
    database:
      connection_string: {{ include "industry-core-hub.postgresql.dsn" . | quote }}
      echo: {{ .Values.backend.configuration.database.echo }}
      timeout: {{ .Values.backend.configuration.database.timeout }}
      retry_interval: {{ .Values.backend.configuration.database.retry_interval }}
    server: {{ .Values.backend.server | toYaml | nindent 6 }}
    cors: {{ .Values.backend.cors | toYaml | nindent 6 }}
    consumer:
      discovery:
        discovery_finder: {{ .Values.backend.configuration.consumer.discovery.discovery_finder | toYaml | nindent 10 }}
        connector_discovery: {{ .Values.backend.configuration.consumer.discovery.connector_discovery | toYaml | nindent 10 }}
        oauth: {{ .Values.backend.configuration.consumer.discovery.oauth | toYaml | nindent 10 }}
        digitalTwinRegistry:
          dct_type_key: {{ .Values.backend.configuration.consumer.discovery.digitalTwinRegistry.dct_type_key | quote }}
          dct_type_filter:
            operandLeft: {{ .Values.backend.configuration.consumer.discovery.digitalTwinRegistry.dct_type_filter.operandLeft | quote }}
            operator: {{ .Values.backend.configuration.consumer.discovery.digitalTwinRegistry.dct_type_filter.operator | quote }}
            operandRight: {{ .Values.backend.configuration.consumer.discovery.digitalTwinRegistry.dct_type_filter.operandRight | quote }}
      connector: {{ .Values.backend.configuration.consumer.connector | toYaml | nindent 8 }}
    provider: {{ .Values.backend.configuration.provider | toYaml | nindent 6 }}
      submodel_dispatcher:
      {{- if eq .Values.backend.configuration.provider.submodel_dispatcher.mode "http" }}
        mode: {{ .Values.backend.configuration.provider.submodel_dispatcher.mode | quote }}
        path: {{ .Values.backend.configuration.provider.submodel_dispatcher.path | quote }}
        apiPath: {{ .Values.backend.configuration.provider.submodel_dispatcher.apiPath | quote }}
        http:
          base_url: {{ .Values.backend.configuration.provider.submodel_dispatcher.http.base_url | quote }}
          api_path: {{ .Values.backend.configuration.provider.submodel_dispatcher.http.api_path | quote }}
          auth:
            enabled: {{ .Values.backend.configuration.provider.submodel_dispatcher.http.auth.enabled }}
            type: {{ .Values.backend.configuration.provider.submodel_dispatcher.http.auth.type | quote }}
            {{- if and .Values.backend.configuration.provider.submodel_dispatcher.http.auth.enabled .Values.backend.configuration.provider.submodel_dispatcher.http.auth.token }}
            token: "${SUBMODEL_SERVICE_TOKEN}"
            {{- else }}
            token: ""
            {{- end }}
            key_name: {{ .Values.backend.configuration.provider.submodel_dispatcher.http.auth.key_name | quote }}
          timeout: {{ .Values.backend.configuration.provider.submodel_dispatcher.http.timeout }}
          verify_ssl: {{ .Values.backend.configuration.provider.submodel_dispatcher.http.verify_ssl }}
      {{- else }}
      {{- /* Filesystem mode - use standard toYaml */}}
      {{ .Values.backend.configuration.provider.submodel_dispatcher | toYaml | nindent 6 }}
      {{- end }}
  logging.yml: |-
    version: 1
    disable_existing_loggers: False

    formatters:
      default:
        format: '%(asctime)s [%(levelname)-8s] [%(name)-15s] %(message)s'
        datefmt: '%Y-%m-%d %H:%M:%S'

    handlers:
      console:
        class: logging.StreamHandler
        formatter: default
        level: DEBUG
        stream: ext://sys.stdout
      file:
        class: logging.handlers.RotatingFileHandler
        formatter: default
        mode: a

    loggers:
      development:
        level: DEBUG
        handlers: [console, file]
        propagate: no

      staging:
        level: DEBUG
        handlers: [console, file]
        propagate: no

      production:
        level: DEBUG
        handlers: [file]
        propagate: no

    root:
      level: {{ .Values.backend.configuration.logger.level | quote }}
      handlers: [console, file]
{{- end -}}
